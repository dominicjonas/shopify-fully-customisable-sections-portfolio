{% schema %}
{
  "name": "Testimonial Carousel",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "What Our Customers Say"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "Don't just take our word for it"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-advance slides",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Auto-advance speed (seconds)",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "textarea",
          "id": "quote",
          "label": "Testimonial Quote",
          "default": "This product has completely transformed my business. The quality and service are outstanding!"
        },
        {
          "type": "text",
          "id": "author",
          "label": "Author Name",
          "default": "Sarah Johnson"
        },
        {
          "type": "text",
          "id": "position",
          "label": "Author Position/Title",
          "default": "CEO, TechCorp"
        },
        {
          "type": "image_picker",
          "id": "author_image",
          "label": "Author Image"
        },
        {
          "type": "range",
          "id": "rating",
          "label": "Star Rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonial Carousel",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "quote": "This product has completely transformed my business. The quality and service are outstanding!",
            "author": "Sarah Johnson",
            "position": "CEO, TechCorp",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "Fast delivery and exceptional customer support. I couldn't be happier with my purchase!",
            "author": "Mike Chen",
            "position": "Marketing Director",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "The attention to detail is incredible. This is exactly what I was looking for!",
            "author": "Emily Davis",
            "position": "Small Business Owner",
            "rating": 4
          }
        }
      ]
    }
  ]
}
{% endschema %}

<section class="testimonial-carousel" data-section-id="{{ section.id }}">
  <div class="testimonial-carousel__container">
    {% if section.settings.heading != blank %}
      <div class="testimonial-carousel__header text-{{ section.settings.text_alignment }}">
        <h2 class="testimonial-carousel__heading">{{ section.settings.heading }}</h2>
        {% if section.settings.subheading != blank %}
          <p class="testimonial-carousel__subheading">{{ section.settings.subheading }}</p>
        {% endif %}
      </div>
    {% endif %}

    {% if section.blocks.size > 0 %}
      <div class="testimonial-carousel__wrapper">
        <div class="testimonial-carousel__track" 
             id="carousel-track-{{ section.id }}"
             data-autoplay="{{ section.settings.autoplay }}"
             data-autoplay-speed="{{ section.settings.autoplay_speed }}">
          {% for block in section.blocks %}
            {% case block.type %}
              {% when 'testimonial' %}
                <div class="testimonial-slide{% if forloop.first %} active{% endif %} text-{{ section.settings.text_alignment }}" 
                     data-block-id="{{ block.id }}">
                  <div class="testimonial-slide__content">
                    {% if block.settings.rating > 0 %}
                      <div class="testimonial-slide__rating" aria-label="Rating: {{ block.settings.rating }} out of 5 stars">
                        {% for i in (1..5) %}
                          {% if i <= block.settings.rating %}
                            <span class="star star--filled">★</span>
                          {% else %}
                            <span class="star star--empty">☆</span>
                          {% endif %}
                        {% endfor %}
                      </div>
                    {% endif %}

                    {% if block.settings.quote != blank %}
                      <blockquote class="testimonial-slide__quote">
                        "{{ block.settings.quote }}"
                      </blockquote>
                    {% endif %}

                    <div class="testimonial-slide__author">
                      {% if block.settings.author_image %}
                        <div class="testimonial-slide__author-image">
                          <img src="{{ block.settings.author_image | img_url: '80x80' }}" 
                               alt="{{ block.settings.author }}"
                               loading="lazy"
                               width="80" 
                               height="80">
                        </div>
                      {% endif %}
                      
                      <div class="testimonial-slide__author-info">
                        {% if block.settings.author != blank %}
                          <cite class="testimonial-slide__author-name">{{ block.settings.author }}</cite>
                        {% endif %}
                        {% if block.settings.position != blank %}
                          <p class="testimonial-slide__author-position">{{ block.settings.position }}</p>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
            {% endcase %}
          {% endfor %}
        </div>

        {% if section.blocks.size > 1 %}
          <!-- Navigation Arrows -->
          <button class="testimonial-carousel__nav testimonial-carousel__nav--prev" 
                  id="prev-{{ section.id }}" 
                  aria-label="Previous testimonial">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          
          <button class="testimonial-carousel__nav testimonial-carousel__nav--next" 
                  id="next-{{ section.id }}" 
                  aria-label="Next testimonial">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- Pagination Dots -->
          <div class="testimonial-carousel__pagination" id="pagination-{{ section.id }}">
            {% for block in section.blocks %}
              <button class="testimonial-carousel__dot{% if forloop.first %} testimonial-carousel__dot--active{% endif %}" 
                      data-slide="{{ forloop.index0 }}"
                      aria-label="Go to testimonial {{ forloop.index }}">
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="testimonial-carousel__empty">
        <p>Add testimonial blocks to display customer reviews.</p>
      </div>
    {% endif %}
  </div>
</section>

<style>
  .testimonial-carousel {
    padding: 4rem 0;
    background-color: #f8f9fa;
  }

  .testimonial-carousel__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .testimonial-carousel__header {
    margin-bottom: 3rem;
  }

  .testimonial-carousel__heading {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 1rem;
    color: #333;
  }

  .testimonial-carousel__subheading {
    font-size: 1.25rem;
    color: #666;
    margin: 0;
  }

  .testimonial-carousel__wrapper {
    position: relative;
    max-width: 800px;
    margin: 0 auto;
  }

  .testimonial-carousel__track {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
  }

  .testimonial-slide {
    display: none;
    padding: 3rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    animation: fadeIn 0.5s ease-in-out;
    min-height: 200px;
  }

  .testimonial-slide:first-child,
  .testimonial-slide.active {
    display: block;
  }

  .testimonial-slide__content {
    max-width: 600px;
    margin: 0 auto;
  }

  .testimonial-slide__rating {
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
  }

  .star {
    color: #ffd700;
    margin-right: 0.25rem;
  }

  .star--empty {
    color: #ddd;
  }

  .testimonial-slide__quote {
    font-size: 1.5rem;
    line-height: 1.6;
    font-style: italic;
    margin: 0 0 2rem 0;
    color: #333;
    position: relative;
  }

  .testimonial-slide__author {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .testimonial-slide__author-image {
    flex-shrink: 0;
  }

  .testimonial-slide__author-image img {
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #e9ecef;
  }

  .testimonial-slide__author-info {
    flex-grow: 1;
  }

  .testimonial-slide__author-name {
    display: block;
    font-style: normal;
    font-weight: bold;
    font-size: 1.1rem;
    color: #333;
    margin-bottom: 0.25rem;
  }

  .testimonial-slide__author-position {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
  }

  .testimonial-carousel__nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    z-index: 10;
  }

  .testimonial-carousel__nav:hover {
    background: #333;
    color: white;
    transform: translateY(-50%) scale(1.1);
  }

  .testimonial-carousel__nav--prev {
    left: -25px;
  }

  .testimonial-carousel__nav--next {
    right: -25px;
  }

  .testimonial-carousel__pagination {
    display: flex;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 2rem;
  }

  .testimonial-carousel__dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: none;
    background-color: #ddd;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .testimonial-carousel__dot:hover,
  .testimonial-carousel__dot--active {
    background-color: #333;
    transform: scale(1.2);
  }

  .testimonial-carousel__empty {
    text-align: center;
    padding: 3rem;
    color: #666;
  }

  .text-left { text-align: left; }
  .text-center { text-align: center; }
  .text-right { text-align: right; }

  .text-center .testimonial-slide__author {
    justify-content: center;
    text-align: center;
  }

  .text-right .testimonial-slide__author {
    justify-content: flex-end;
    text-align: right;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .testimonial-carousel {
      padding: 2rem 0;
    }

    .testimonial-carousel__heading {
      font-size: 2rem;
    }

    .testimonial-slide {
      padding: 2rem 1.5rem;
      margin: 0 1rem;
    }

    .testimonial-slide__quote {
      font-size: 1.25rem;
    }

    .testimonial-slide__quote::before {
      font-size: 3rem;
      top: -0.5rem;
      left: -0.5rem;
    }

    .testimonial-carousel__nav {
      width: 40px;
      height: 40px;
    }

    .testimonial-carousel__nav--prev {
      left: -10px;
    }

    .testimonial-carousel__nav--next {
      right: -10px;
    }

    .testimonial-slide__author {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }

    .text-left .testimonial-slide__author,
    .text-right .testimonial-slide__author {
      flex-direction: column;
      text-align: center;
    }
  }

  @media (max-width: 480px) {
    .testimonial-slide {
      padding: 1.5rem 1rem;
      margin: 0 0.5rem;
    }

    .testimonial-carousel__nav {
      display: none;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const carousel = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (!carousel) return;

  const track = carousel.querySelector('#carousel-track-{{ section.id }}');
  const slides = carousel.querySelectorAll('.testimonial-slide');
  const prevBtn = carousel.querySelector('#prev-{{ section.id }}');
  const nextBtn = carousel.querySelector('#next-{{ section.id }}');
  const dots = carousel.querySelectorAll('.testimonial-carousel__dot');
  
  if (slides.length <= 1) return;

  let currentSlide = 0;
  let autoplayInterval;

  function showSlide(index) {
    slides.forEach((slide, i) => {
      slide.classList.toggle('active', i === index);
    });
    
    dots.forEach((dot, i) => {
      dot.classList.toggle('testimonial-carousel__dot--active', i === index);
    });
    
    currentSlide = index;
  }

  function nextSlide() {
    const next = (currentSlide + 1) % slides.length;
    showSlide(next);
  }

  function prevSlide() {
    const prev = (currentSlide - 1 + slides.length) % slides.length;
    showSlide(prev);
  }

  function startAutoplay() {
    const autoplay = track.dataset.autoplay === 'true';
    const speed = parseInt(track.dataset.autoplaySpeed) * 1000;
    
    if (autoplay && slides.length > 1) {
      autoplayInterval = setInterval(nextSlide, speed);
    }
  }

  function stopAutoplay() {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
    }
  }

  function restartAutoplay() {
    stopAutoplay();
    startAutoplay();
  }

  // Initialize first slide
  showSlide(0);

  // Event listeners
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      prevSlide();
      restartAutoplay();
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      nextSlide();
      restartAutoplay();
    });
  }

  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      showSlide(index);
      restartAutoplay();
    });
  });

  // Pause autoplay on hover
  carousel.addEventListener('mouseenter', stopAutoplay);
  carousel.addEventListener('mouseleave', startAutoplay);

  // Keyboard navigation
  carousel.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      prevSlide();
      restartAutoplay();
    } else if (e.key === 'ArrowRight') {
      nextSlide();
      restartAutoplay();
    }
  });

  // Touch/swipe support
  let touchStartX = 0;
  let touchEndX = 0;

  carousel.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
    stopAutoplay();
  });

  carousel.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
    startAutoplay();
  });

  function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;

    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) {
        nextSlide();
      } else {
        prevSlide();
      }
    }
  }

  // Start autoplay
  startAutoplay();
});
</script>